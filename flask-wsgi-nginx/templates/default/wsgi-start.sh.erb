#!/bin/bash

# Launch Gunicorn server
# The purpose of this script is to set some environment variables before launching gunicorn server.

cd <%= @app_dir %>

source venv/bin/activate

<% @wsgi = node["flask-wsgi-nginx"]["wsgi"] %>

<% if @wsgi["server"] == "gunicorn" %>
exec gunicorn \
    <%= @wsgi["module"] %> \
    --name "`git show --pretty=format:"%h %s" -s HEAD`" \
    --workers=<%= @wsgi["workers"] %> \
    --timeout=<%= @wsgi["worker_timeout"] %> \
    --graceful-timeout=<%= @wsgi["graceful_timeout"] %> \
    --log-level=<%= @wsgi["log_level"] %> \
    --worker-class=<%= @wsgi["worker_class"] %> \
    --log-syslog-to=<%= helper.wsgi_syslog %>
<% elsif @wsgi["server"] == "uwsgi" %>
exec uwsgi \
    --module <%= @wsgi["module"] %> \
    --socket /tmp/wsgi.sock \
    --chmod-socket \
    --vacuum \
    --die-on-term \
    --procname "`git show --pretty=format:"%h %s" -s HEAD`" \
    --workers=<%= @wsgi["workers"] %> \
    <% if @wsgi["async"] > 0 %>
    --async <%= @wsgi["async"] %> \
    --<%= @wsgi["worker_class"] %>
    <% end %>
<% end %>
