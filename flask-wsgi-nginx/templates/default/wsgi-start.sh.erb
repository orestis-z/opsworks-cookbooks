#!/bin/bash

# Launch Gunicorn server
# The purpose of this script is to set some environment variables before launching gunicorn server.

cd <%= @app_dir %>

source venv/bin/activate

<% if node["flask-wsgi-nginx"]["wsgi"]["server"] == "gunicorn" %>
exec gunicorn \
    <%= node['flask-wsgi-nginx']['wsgi']['module'] %> \
    --name "`git show --pretty=format:"%h %s" -s HEAD`" \
    --workers=<%= node['flask-wsgi-nginx']['wsgi']["workers"] %> \
    --timeout=<%= node['flask-wsgi-nginx']['wsgi']["worker_timeout"] %> \
    --graceful-timeout=<%= node['flask-wsgi-nginx']['wsgi']["graceful_timeout"] %> \
    --log-level=<%= node['flask-wsgi-nginx']['wsgi']["log_level"] %> \
    --worker-class=<%= node['flask-wsgi-nginx']['wsgi']["worker_class"] %> \
    --log-syslog-to=<%= helper.wsgi_syslog %>
<% elsif node["flask-wsgi-nginx"]["wsgi"]["server"] == "uwsgi" %>
exec uwsgi \
    --module <%= node['flask-wsgi-nginx']['wsgi']['module'] %> \
    --socket /tmp/wsgi.sock \
    --chmod-socket \
    --vacuum \
    --die-on-term \
    --procname "`git show --pretty=format:"%h %s" -s HEAD`" \
    --workers=<%= node['flask-wsgi-nginx']['wsgi']["workers"] %> \
    <% if node["flask-wsgi-nginx"]["wsgi"]["async"] > 0 %>
    --async <%= node["flask-wsgi-nginx"]["wsgi"]["async"] %> \
    --<%= node["flask-wsgi-nginx"]["wsgi"]["worker_class"] %>
    <% end %>
<% end %>
