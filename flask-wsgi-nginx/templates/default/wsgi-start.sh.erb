#!/bin/bash

# Launch Gunicorn server
# The purpose of this script is to set some environment variables before launching gunicorn server.

cd <%= @app_dir %>

<% @wsgi = node["flask-wsgi-nginx"]["wsgi"] %>

<% if @wsgi["server"] == "gunicorn" %>
exec pipenv run gunicorn \
    <%= @wsgi["module"] %> \
    --config <%= @wsgi["config"] %> \
    --name "`git show --pretty=format:"%h %s" -s HEAD`" \
    --log-syslog-to <%= helper.wsgi_syslog %>
<% elsif @wsgi["server"] == "uwsgi" %>
exec pipenv run uwsgi \
    --module <%= @wsgi["module"] %> \
    --socket /tmp/wsgi.sock \
    --chmod-socket \
    --vacuum \
    --die-on-term \
    --procname "`git show --pretty=format:"%h %s" -s HEAD`" \
    --workers <%= @wsgi["workers"] %> \
    <% if @wsgi["async"] > 0 %>
    --async <%= @wsgi["async"] %> \
    --<%= @wsgi["worker_class"] %>
    <% end %>
<% end %>
